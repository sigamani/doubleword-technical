FROM python:3.10-slim

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV CUDA_VISIBLE_DEVICES=""

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Upgrade pip
RUN python3 -m pip install --upgrade pip --no-cache-dir

# Install PyTorch CPU first (newer version for transformers compatibility)
RUN python3 -m pip install --no-cache-dir \
    torch==2.1.0+cpu \
    --index-url https://download.pytorch.org/whl/cpu

# Install other dependencies from PyPI
RUN python3 -m pip install --no-cache-dir \
    ray[data]==2.49.1 \
    vllm==0.10.0 \
    transformers>=4.30.0 \
    datasets>=2.10.0 \
    pyyaml>=6.0 \
    requests>=2.28.0 \
    prometheus-client>=0.14.0 \
    fastapi>=0.68.0 \
    uvicorn[standard]>=0.15.0 \
    pydantic>=1.8.0 \
    redis>=4.0.0 \
    huggingface_hub>=0.17.0 \
    nest-asyncio>=1.5.0

# Set working directory
WORKDIR /app

# Copy project files
COPY . /app/

# Expose ports
EXPOSE 8000 8265

# Default command
CMD ["python", "app/ray_data_batch_inference.py"]